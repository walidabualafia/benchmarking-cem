# Use Rocky Linux 8 for RHEL8 binary compatibility
FROM rockylinux:8

# Use bash login shell so environment variables work
SHELL ["/bin/bash", "-lc"]

# Install prerequisites: wget, bzip2, tar, Java, OpenGL libraries
RUN dnf install -y \
      wget \
      bzip2 \
      tar \
      java-11-openjdk-headless \
      mesa-libGL \
      mesa-libGLU \
      libXrandr \
      libXinerama \
      libXi && \
    dnf clean all

# Define IMOD version and download URL (RHEL7 build might extract more cleanly)
ENV IMOD_VERSION=5.1.3
ENV IMOD_URL=https://bio3d.colorado.edu/imod/AMD64-RHEL5/imod_${IMOD_VERSION}_RHEL8-64_CUDA12.0.sh

# Download and install IMOD non-interactively
RUN wget "$IMOD_URL" -O /tmp/imod_installer.sh && \
    chmod +x /tmp/imod_installer.sh && \
    # Use '-y' flag if supported, otherwise pipe 'yes'
    ( /tmp/imod_installer.sh || Y | /tmp/imod_installer.sh ) && \
    rm /tmp/imod_installer.sh

# Add IMOD binaries and libraries to PATH and LD_LIBRARY_PATH
ENV PATH=/usr/local/IMOD/bin:$PATH
ENV LD_LIBRARY_PATH=/usr/local/IMOD/lib

# Default to an interactive shell
CMD ["bash"]
